<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOM Results - REFEEDO</title>
    <link rel="icon" href="{{ url_for('static', filename='images/logo.png') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Roboto:ital,wght@0,100..900;1,100..900&family=Smooch+Sans:wght@100..900&display=swap" rel="stylesheet">
    <style>
        :root{
            --color-primary: #42603b;
            --color-half:#a8c69e;
            --color-success: #41f1b6;
            --color-warning:#ffbb55;
            --color-white: #fff;
            --color-info-dark:#7d8da1;
            --color-info-light: #dce1eb;
            --color-dark:#363949;
            --color-light: rgba(132,139,200,0.18);
            --color-primary-variant:#111e88;
            --color-dark-variant: #677483;
            --color-background:#ffffff;

            --card-border-radius: 2rem;
            --border-radius-1: 0.4rem;
            --border-radius-2: 0.8rem;
            --border-radius-3: 1.2rem;

            --card-padding: 1.8rem;
            --padding-1: 1.2rem;

            --box-shadow: 0 1rem 2rem var(--color-light);
        }

        html{
            font-size: 14px;
        }

        body{
            width: 100vw;
            height: 100vh;
            font-size: 0.88rem;
            background: var(--color-background);
            user-select: none;
            overflow-x: hidden;
        }

        *{
            margin: 0;
            padding: 0;
            outline: 0;
            appearance: none;
            border: 0;
            text-decoration: none;
            list-style: none;
            box-sizing: border-box;
            font-family: 'montserrat';
        }

        .container{
            display: grid;
            width: 96%;
            margin: 0 auto;
            gap: 1.8rem;
            grid-template-columns: 14rem auto 23rem;
        }

        a{
            color: var(--color-dark);
        }

        img{
            display: block;
            width: 100%;
        }

        h1{
            font-weight: 800;
            font-size: 1.8rem;
        }

        h2{
            font-size: 1.4rem;
        }

        h3{
            font-size: 0.8rem;
        }

        h5{
            font-size: 0.7rem;
        }

        small{
            font-size: 0.75rem;
        }

        .profile-photo{
            width: 2.8rem;
            height: 2.8rem;
            border-radius: 50%;
            overflow: hidden;
        }

        .text-muted{
            color: var(--color-info-dark);
        }

        p{
            color: var(--color-dark-variant);
        }

        b{
            color: var(--color-dark);
        }

        .primary{
            color: var(--color-primary);
        }

        .half{
            color: var(--color-half);
        }

        .success{
            color: var(--color-success);
        }

        .warning{
            color: var(--color-warning);
        }

        aside{
            height: 100vh;
        }

        aside .top{
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 1.4rem;
            padding: 0 1rem;
        }

        aside h2{
            margin: 0;
            font-size: 1.4rem;
            font-weight: 600;
        }

        aside .logo{
            display: flex;
            gap: 0.8rem;
            align-items: center;
        }

        aside .logo img{
            width: 2rem;
            height: 2rem;
        }

        aside .close-btn{
            display: none;
            font-size: 2rem;
        }

        aside .sidebar{
            display: flex;
            flex-direction: column;
            height: 86vh;
            position: relative;
            top: 3rem;
        }

        aside h3{
            font-weight: 500;
        }

        aside .sidebar a{
            display: flex;
            color: var(--color-info-dark);
            margin-left: 2rem;
            gap: 1rem;
            align-items: center;
            position: relative;
            height: 3.7rem;
            transition: all 300ms ease;
        }

        aside .sidebar a i{
            font-size: 1.6rem;
            transition: all 300ms ease; 
        }

        aside .sidebar a:last-child{
            position: absolute;
            bottom: 2rem;
            width: 100%;
        }

        aside .sidebar a.active{
            background: var(--color-light);
            color: var(--color-primary);
            margin-left: 0;
        }

        aside .sidebar a.active:before{
            content: '';
            width: 6px;
            height: 100%;
            background: var(--color-primary);
        }

        aside .sidebar a.active span{
            color: var(--color-primary);
            margin-left: calc(1rem - 3px);
        }

        aside .sidebar a:hover{
            color: var(--color-primary);
        }

        aside .sidebar a:hover i{
            margin-left: 1rem;
        }

        .top-right-header{
            grid-column: 2 / 3;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 1.4rem 1rem;
            margin-top: 1.4rem;
        }

        .top-right-header .profile{
            display: flex;
            text-align: right;
            gap: 0.5rem;
        }

        main{
            margin-top: 4rem;
        }

        h1{
            font-weight: 800;
            font-size: 1.8rem;
            color: var(--color-primary);
            margin-bottom: 1rem;
        }

        h2{
            font-size: 1.4rem;
            color: var(--color-dark);
            margin-bottom: 1rem;
        }

        .bom-header{
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius-2);
            box-shadow: var(--box-shadow);
            margin-bottom: 2rem;
            border-left: 4px solid var(--color-primary);
        }

        .bom-header h2{
            color: var(--color-primary);
            margin-bottom: 0.5rem;
        }

        .bom-header p{
            color: var(--color-dark-variant);
            font-size: 1rem;
        }

        .bom-table{
            background: white;
            border-radius: var(--border-radius-2);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        .bom-table table{
            width: 100%;
            border-collapse: collapse;
        }

        .bom-table th{
            background: var(--color-primary);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }

        .bom-table td{
            padding: 1rem;
            border-bottom: 1px solid var(--color-light);
        }

        .bom-table tr:hover{
            background: var(--color-light);
        }

        .quantity-cell{
            text-align: center;
            font-weight: bold;
            color: var(--color-primary);
        }

        .unit-cell{
            text-align: center;
        }

        .action-buttons{
            margin-top: 2rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn{
            padding: 0.8rem 1.5rem;
            border-radius: var(--border-radius-1);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 300ms ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary{
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover{
            background: var(--color-primary-variant);
        }

        .btn-secondary{
            background: var(--color-info-light);
            color: var(--color-dark);
        }

        .btn-secondary:hover{
            background: var(--color-info-dark);
            color: white;
        }

        .menu-summary{
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius-2);
            box-shadow: var(--box-shadow);
            margin-bottom: 2rem;
        }

        .menu-summary h3{
            color: var(--color-primary);
            margin-bottom: 1rem;
        }

        .menu-summary p{
            color: var(--color-dark-variant);
            margin-bottom: 0.5rem;
        }

        /* Detailed BOM Styles */
        .detailed-bom{
            background: white;
            border-radius: var(--border-radius-2);
            box-shadow: var(--box-shadow);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .detailed-bom h3{
            background: var(--color-primary);
            color: white;
            padding: 1rem;
            margin: 0;
        }

        .day-section{
            border-bottom: 2px solid var(--color-light);
            margin-bottom: 1rem;
        }

        .day-section:last-child{
            border-bottom: none;
        }

        .day-header{
            background: var(--color-info-light);
            color: var(--color-dark);
            padding: 1rem;
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .meal-section{
            margin: 1rem;
            border: 1px solid var(--color-light);
            border-radius: var(--border-radius-1);
            overflow: hidden;
        }

        .meal-header{
            background: var(--color-warning-light);
            color: var(--color-dark);
            padding: 0.8rem 1rem;
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .dish-section{
            margin: 1rem;
            border: 1px solid var(--color-light);
            border-radius: var(--border-radius-1);
            overflow: hidden;
        }

        .dish-header{
            background: var(--color-success-light);
            color: var(--color-dark);
            padding: 0.6rem 1rem;
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .ingredient-table{
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .ingredient-table th{
            background: var(--color-light);
            color: var(--color-dark);
            padding: 0.8rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .ingredient-table td{
            padding: 0.6rem 0.8rem;
            border-bottom: 1px solid var(--color-light);
            font-size: 0.9rem;
        }

        .ingredient-table tr:hover{
            background: var(--color-light);
        }

        .no-ingredients{
            padding: 1rem;
            color: var(--color-dark-variant);
            font-style: italic;
            text-align: center;
            margin: 0;
        }

        .total-bom{
            background: white;
            border-radius: var(--border-radius-2);
            box-shadow: var(--box-shadow);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .total-bom h3{
            background: var(--color-primary);
            color: white;
            padding: 1rem;
            margin: 0;
        }

        /* RIGHT SECTION STYLES */
        .right{
            margin-top: 1.4rem;
        }

        .right .top{
            display: flex;
            justify-content: end;
            gap: 2rem;
        }

        .right .top button{
            display: none;
        }

        .right .top .profile{
            display: flex;
            text-align: right;
            gap: 0.5rem;
        }

        @media print {
            aside, .action-buttons {
                display: none;
            }
            main {
                margin-left: 0;
                padding: 1rem;
            }
            .container {
                grid-template-columns: 1fr;
            }
            .day-section {
                page-break-inside: avoid;
            }
            .meal-section {
                page-break-inside: avoid;
            }
            .dish-section {
                page-break-inside: avoid;
            }
        }

        /* MEDIA QUERIES */
        @media screen and (max-width:1200px) {
            .container{
                width: 94%;
                grid-template-columns: 7rem auto 23rem;
            }
            aside .logo h2{
                display: none;
            }
            aside .sidebar h3{
                display: none;
            }
            aside .sidebar a:last-child{
                position: relative;
                margin-top: 1.8rem;
            }
            main .insights{
                grid-template-columns: 1fr;
                gap: 0;
            }
            main .recent-orders{
                width: 94%;
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
                margin: 2rem 0 0 8.8rem;
            }
            main .recent-orders table{
                width: 83vw;
            }
            main table thead tr th:last-child,
            main table thead tr th:first-child{
                display: none;
            }
            main table tbody tr td:last-child,
            main table tbody tr td:first-child{
                display: none;
            }
            .top-right-header {
                padding-right: 2rem; /* Adjust padding for smaller screens if needed */
                margin-top: 1.4rem; /* Keep consistent margin */
            }
        }

        /* MEDIA QUERIES FOR MOBILE */
        @media screen and (max-width:768px) {
            .container{
                width: 100%;
                grid-template-columns: 1fr;
            }
            aside{
                position: fixed;
                left: -100%;
                background: var(--color-white);
                width: 18rem;
                z-index: 3;
                box-shadow: 1rem 3rem 4rem var(--color-light);
                height: 100vh;
                padding: var(--card-padding);
                display: none;
                animation: showMenu 400ms ease forwards;
            }
            @keyframes showMenu{
                to{
                    left: 0;
                }
            }
            aside .logo{
                margin-left: 1rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
                width: 100%;
            }
            aside .logo h2{
                display: inline;
                margin: 0;
            }
            aside .sidebar h3{
                display: inline;
            }
            aside .sidebar a{
                width: 100%;
                height: 3.4rem;
            }
            aside .sidebar a:last-child{
                position: absolute;
                bottom: 5rem;
            }
            aside .close-btn{
                display: inline-block;
                cursor: pointer;
                margin: 0;
                font-size: 1.5rem;
            }
            main{
                margin-top: 8rem;
                padding: 0 1rem;
            }
            main .recent-orders{
                position: relative;
                margin: 3rem 0 0 0;
                width: 100%;
            }
            main .recent-orders table{
                width: 100%;
                margin: 0;
            }
            .top-right-header{
                position: fixed;
                top: 0;
                left: 0;
                align-items: center;
                padding: 0 0.8rem;
                height: 4.6rem;
                background: var(--color-white);
                width: 100%;
                margin: 0;
                z-index: 2;
                box-shadow: 0 1rem 1rem var(--color-light);
            }
            .top-right-header .profile .info{
                display: none;    
            }
            .top-right-header button{
                display: inline-block;
                background: transparent;
                cursor: pointer;
                color: var(--color-dark);
                position: absolute;
                left: 1rem;
            }
            .top-right-header button span{
                font-size: 2rem;
            }
            .right{
                width: 94%;
                margin: 0 auto 4rem;
            }
            .right .top{
                position: fixed;
                top: 0;
                left: 0;
                align-items: center;
                padding: 0 0.8rem;
                height: 4.6rem;
                background: var(--color-white);
                width: 100%;
                margin: 0;
                z-index: 2;
                box-shadow: 0 1rem 1rem var(--color-light);
            }
            .right .profile .info{
                display: none;    
            }
            .right .top button{
                display: inline-block;
                background: transparent;
                cursor: pointer;
                color: var(--color-dark);
                position: absolute;
                left: 1rem;
            }
            .right .top button span{
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <aside>
            <div class="top">
                <div class="logo">
                    <a href="/dashboard" style="display: flex; gap: 0.8rem; align-items: center; text-decoration: none; color: inherit;">
                        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="">
                        <h2>REF<span class="half">EEDO</span></h2>
                    </a>
                </div>
                <div class="close-btn"><i class="fa-solid fa-xmark"></i></div>
            </div>

            <div class="sidebar">
                <a href="/dashboard" class="{% if active_page == 'dashboard' %}active{% endif %}">
                    <i class="fa-solid fa-table-columns"></i>
                    <h3>DashBoard</h3>
                </a>
                <a href="/menu" class="{% if active_page == 'menu' %}active{% endif %}">
                    <i class="fa-solid fa-plate-wheat"></i>
                    <h3>Menu Management</h3>
                </a>
                <a href="/bom" class="{% if active_page == 'bom' %}active{% endif %}">
                    <i class="fa-solid fa-paperclip"></i>
                    <h3>BOM</h3>
                </a>
                <a href="/studentstaff" class="{% if active_page == 'studentstaff' %}active{% endif %}">
                    <i class="fa-regular fa-folder-closed"></i>
                    <h3>Student and Staff</h3>
                </a>
                <a href="/inventory" class="{% if active_page == 'inventory' %}active{% endif %}">
                    <i class="fa-regular fa-cart-flatbed"></i>
                    <h3>Inventory</h3>
                </a>
                <a href="/supplier" class="{% if active_page == 'supplier' %}active{% endif %}">
                    <i class="fa-solid fa-boxes-packing"></i>
                    <h3>Supplier</h3>
                </a>
                <a href="/analytics" class="{% if active_page == 'analytics' %}active{% endif %}">
                    <i class="fa-solid fa-chart-line"></i>
                    <h3>Analytics</h3>
                </a>
                <a href="/pax" class="{% if active_page == 'pax' %}active{% endif %}">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i>
                    <h3>Meal Predictor</h3>
                </a>
                <a href="/settings" class="{% if active_page == 'settings' %}active{% endif %}">
                    <i class="fa-solid fa-gear"></i>
                    <h3>Settings</h3>
                </a>
                <a href="/logout">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i>
                    <h3>Log Out</h3>
                </a>
            </div>
        </aside>

        <main>
            <div class="bom-header">
                <h2><i class="fa-solid fa-calculator"></i> Bill of Materials (BOM)</h2>
                <p><strong>Number of Students:</strong> {{ num_students }}</p>
                <p><strong>Generated on:</strong> <span id="currentDate"></span></p>
            </div>

            <div class="menu-summary">
                <h3><i class="fa-solid fa-calendar"></i> Menu Summary</h3>
                <p><strong>Menu Period:</strong> {{ menu_data.keys()|list|first }} to {{ menu_data.keys()|list|last }}</p>
                <p><strong>Total Days:</strong> {{ menu_data|length }} days</p>
                <p><strong>Meals Included:</strong> Breakfast, Lunch, Snacks, Dinner, Brunch (Sunday)</p>
            </div>

            <!-- Detailed BOM Breakdown -->
            <div class="detailed-bom">
                <h3><i class="fa-solid fa-list-ul"></i> Detailed Bill of Materials</h3>
                
                {% for day, meals in detailed_bom.items() %}
                <div class="day-section">
                    <h4 class="day-header">{{ day }}</h4>
                    
                    {% for meal_type, dishes in meals.items() %}
                    <div class="meal-section">
                        <h5 class="meal-header">{{ meal_type }}</h5>
                        
                        {% for dish_name, ingredients in dishes.items() %}
                        <div class="dish-section">
                            <h6 class="dish-header">{{ dish_name }}</h6>
                            
                            {% if ingredients %}
                            <table class="ingredient-table">
                                <thead>
                                    <tr>
                                        <th>Raw Ingredient</th>
                                        <th>Quantity</th>
                                        <th>Unit</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for ingredient in ingredients %}
                                    <tr>
                                        <td>{{ ingredient.ingredient }}</td>
                                        <td class="quantity-cell">{{ ingredient.quantity }}</td>
                                        <td class="unit-cell">{{ ingredient.unit }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <p class="no-ingredients">No ingredient data available for this dish</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>

            <!-- Total BOM Summary -->
            <div class="total-bom">
                <h3><i class="fa-solid fa-calculator"></i> Total Raw Ingredients Required</h3>
                <div class="bom-table">
                    <table>
                        <thead>
                            <tr>
                                <th><i class="fa-solid fa-list"></i> Ingredient</th>
                                <th style="text-align: center;"><i class="fa-solid fa-weight-hanging"></i> Total Quantity</th>
                                <th style="text-align: center;"><i class="fa-solid fa-ruler"></i> Unit</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in bom_results %}
                            <tr>
                                <td>{{ item.ingredient }}</td>
                                <td class="quantity-cell">{{ item.quantity }}</td>
                                <td class="unit-cell">{{ item.unit }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="action-buttons">
                <button onclick="window.print()" class="btn btn-primary">
                    <i class="fas fa-print"></i> Print BOM
                </button>
                <a href="/menu" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Menu
                </a>
                <button onclick="exportToExcel()" class="btn btn-primary">
                    <i class="fas fa-file-excel"></i> Export to Excel
                </button>
                <button onclick="exportToCSV()" class="btn btn-secondary">
                    <i class="fas fa-file-csv"></i> Export to CSV
                </button>
                <button onclick="testExcelExport()" class="btn btn-secondary" style="font-size: 0.8rem;">
                    <i class="fas fa-bug"></i> Test Excel
                </button>
            </div>
        </main>
        <div class="right">
            <div class="top">
                <button id="menu-btn"><i class="fa-solid fa-bars"></i></button>
                <div class="profile">
                    <div class="info">
                        <p>Hey,</p>
                        <small class="text-muted">Admin</small>
                    </div>
                    <div class="profile-photo">
                        <img src="{{ url_for('static', filename='images/profile2.jpg') }}" alt="profile">
                    </div>
                </div>
            </div>
            <!---END OF TOP-->
        </div>
    </div>

    <!-- Hidden inputs to store BOM data -->
    <input type="hidden" id="bomData" value='{{ bom_results|tojson }}'>
    <input type="hidden" id="detailedBomData" value='{{ detailed_bom|tojson }}'>

    <script>
        // Set current date
        document.getElementById('currentDate').textContent = new Date().toLocaleString();
        
        // Check if SheetJS library is loaded
        function checkSheetJS() {
            if (typeof XLSX === 'undefined') {
                console.warn('SheetJS library not loaded. Excel export will not work.');
                // Disable Excel button and show warning
                const excelBtn = document.querySelector('button[onclick="exportToExcel()"]');
                if (excelBtn) {
                    excelBtn.disabled = true;
                    excelBtn.title = 'Excel library not loaded. Use CSV export instead.';
                    excelBtn.style.opacity = '0.5';
                }
                return false;
            }
            
            // Test if the library is actually working
            try {
                const testWb = XLSX.utils.book_new();
                const testWs = XLSX.utils.aoa_to_sheet([['Test']]);
                XLSX.utils.book_append_sheet(testWb, testWs, "Test");
                console.log('SheetJS library is working correctly');
                return true;
            } catch (error) {
                console.error('SheetJS library test failed:', error);
                return false;
            }
        }
        
        // Check on page load with a delay to ensure library is loaded
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                checkSheetJS();
            }, 1000); // Wait 1 second for library to load

            // Handle sidebar menu
            const sideMenu = document.querySelector("aside");
            const menuBtn = document.querySelector("#menu-btn");
            const closeBtn = document.querySelector(".close-btn");

            if (menuBtn) {
                menuBtn.addEventListener('click', () => {
                    sideMenu.style.display = 'block';
                });
            }

            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    sideMenu.style.display = 'none';
                });
            }
        });
        
        function exportToExcel() {
            try {
                // Check if XLSX library is loaded
                if (typeof XLSX === 'undefined') {
                    console.error('XLSX library not loaded');
                    alert('Excel library not loaded. Please refresh the page and try again, or use the CSV export option.');
                    return;
                }
                
                // Show loading state
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                btn.disabled = true;
                
                console.log('Starting Excel export...');
                
                // Get BOM data from hidden inputs
                const detailedBomData = JSON.parse(document.getElementById('detailedBomData').value);
                const totalBomData = JSON.parse(document.getElementById('bomData').value);
                
                console.log('Detailed BOM data:', detailedBomData);
                console.log('Total BOM data:', totalBomData);
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                
                // Create detailed BOM worksheet
                let detailedRows = [];
                
                // Add header
                detailedRows.push(['Day', 'Meal Type', 'Dish', 'Raw Ingredient', 'Quantity', 'Unit']);
                
                // Process detailed data
                for (const [day, meals] of Object.entries(detailedBomData)) {
                    for (const [mealType, dishes] of Object.entries(meals)) {
                        for (const [dishName, ingredients] of Object.entries(dishes)) {
                            if (ingredients && ingredients.length > 0) {
                                for (const ingredient of ingredients) {
                                    detailedRows.push([
                                        day,
                                        mealType,
                                        dishName,
                                        ingredient.ingredient,
                                        ingredient.quantity,
                                        ingredient.unit
                                    ]);
                                }
                            } else {
                                detailedRows.push([day, mealType, dishName, 'No ingredient data available', '', '']);
                            }
                        }
                    }
                }
                
                console.log('Detailed rows created:', detailedRows.length);
                
                const detailedWs = XLSX.utils.aoa_to_sheet(detailedRows);
                XLSX.utils.book_append_sheet(wb, detailedWs, "Detailed BOM");
                
                // Create total BOM worksheet
                let totalRows = [['Ingredient', 'Total Quantity', 'Unit']];
                for (const item of totalBomData) {
                    totalRows.push([item.ingredient, item.quantity, item.unit]);
                }
                
                console.log('Total rows created:', totalRows.length);
                
                const totalWs = XLSX.utils.aoa_to_sheet(totalRows);
                XLSX.utils.book_append_sheet(wb, totalWs, "Total BOM");
                
                // Generate and trigger download
                const fileName = `BOM_Detailed_{{ num_students }}_students.xlsx`;
                
                console.log('Attempting to download file:', fileName);
                
                // Try to write the file
                XLSX.writeFile(wb, fileName);
                
                console.log('Excel file generated successfully!');
                
                // Show success message and restore button
                setTimeout(() => {
                    alert('Excel file downloaded successfully!');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 1000);
                
            } catch (error) {
                console.error("Error in exportToExcel:", error);
                
                // Restore button state
                const btn = event.target;
                btn.innerHTML = '<i class="fas fa-file-excel"></i> Export to Excel';
                btn.disabled = false;
                
                // Provide specific error messages
                if (error.message.includes('XLSX') || error.message.includes('undefined')) {
                    alert('Excel library error. Please refresh the page and try again, or use the CSV export option.');
                } else if (error.message.includes('JSON')) {
                    alert('Data parsing error. Please try generating the BOM again.');
                } else {
                    alert('Error generating Excel file: ' + error.message + '\n\nPlease try the CSV export option instead.');
                }
            }
        }
        
        // Add a fallback export function using CSV if XLSX fails
        function exportToCSV() {
            try {
                // Show loading state
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                btn.disabled = true;
                
                const detailedBomData = JSON.parse(document.getElementById('detailedBomData').value);
                const totalBomData = JSON.parse(document.getElementById('bomData').value);
                
                let csvContent = "data:text/csv;charset=utf-8,";
                
                // Add detailed BOM data
                csvContent += "Day,Meal Type,Dish,Raw Ingredient,Quantity,Unit\n";
                
                for (const [day, meals] of Object.entries(detailedBomData)) {
                    for (const [mealType, dishes] of Object.entries(meals)) {
                        for (const [dishName, ingredients] of Object.entries(dishes)) {
                            if (ingredients && ingredients.length > 0) {
                                for (const ingredient of ingredients) {
                                    csvContent += `${day},${mealType},${dishName},${ingredient.ingredient},${ingredient.quantity},${ingredient.unit}\n`;
                                }
                            } else {
                                csvContent += `${day},${mealType},${dishName},No ingredient data available,,\n`;
                            }
                        }
                    }
                }
                
                // Add total BOM data
                csvContent += "\n\nTOTAL INGREDIENTS\n";
                csvContent += "Ingredient,Total Quantity,Unit\n";
                
                for (const item of totalBomData) {
                    csvContent += `${item.ingredient},${item.quantity},${item.unit}\n`;
                }
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `BOM_Detailed_{{ num_students }}_students.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log('CSV file downloaded successfully!');
                
                // Show success message and restore button
                setTimeout(() => {
                    alert('CSV file downloaded successfully!');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 1000);
                
            } catch (error) {
                console.error("Error in exportToCSV:", error);
                
                // Restore button state
                const btn = event.target;
                btn.innerHTML = '<i class="fas fa-file-csv"></i> Export to CSV';
                btn.disabled = false;
                
                alert('Error generating CSV file: ' + error.message);
            }
        }

        // Test function to debug Excel export issues
        function testExcelExport() {
            console.log('=== Excel Export Test ===');
            console.log('XLSX library status:', typeof XLSX !== 'undefined' ? 'Loaded' : 'Not loaded');
            
            if (typeof XLSX === 'undefined') {
                alert('❌ XLSX library is not loaded!\n\nPlease refresh the page and try again.');
                return;
            }
            
            try {
                console.log('Testing basic Excel functionality...');
                
                // Create a simple test workbook
                const testWb = XLSX.utils.book_new();
                const testData = [
                    ['Test', 'Data'],
                    ['Hello', 'World'],
                    [1, 2, 3]
                ];
                const testWs = XLSX.utils.aoa_to_sheet(testData);
                XLSX.utils.book_append_sheet(testWb, testWs, "Test Sheet");
                
                // Try to write the file
                const testFileName = 'test_excel_export.xlsx';
                XLSX.writeFile(testWb, testFileName);
                
                console.log('✅ Excel test successful!');
                alert('✅ Excel export is working!\n\nA test file "test_excel_export.xlsx" should have been downloaded.');
                
            } catch (error) {
                console.error('❌ Excel test failed:', error);
                alert('❌ Excel test failed!\n\nError: ' + error.message + '\n\nPlease check the browser console for more details.');
            }
        }
    </script>
    <!-- Add SheetJS library for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <!-- Fallback SheetJS CDN -->
    <script>
        // Fallback if the main CDN fails
        if (typeof XLSX === 'undefined') {
            console.log('Loading fallback SheetJS library...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/xlsx@0.19.3/dist/xlsx.full.min.js';
            script.onload = function() {
                console.log('Fallback SheetJS library loaded successfully');
                checkSheetJS();
            };
            script.onerror = function() {
                console.error('Both SheetJS CDNs failed to load');
            };
            document.head.appendChild(script);
        }
    </script>
</body>
</html> 